
services:
  style:
    build:
      context: .
      dockerfile: Dockerfile
    image: neural-style:gpu-cuda126
    working_dir: /app
    command: >-
      bash -lc "bash /app/morph.sh"
    volumes:
      - ./:/app
    env_file:
      - .env
    environment:
      OMP_NUM_THREADS: "24"
      OPENBLAS_NUM_THREADS: "24"
      MKL_NUM_THREADS: "24"
      NUMEXPR_NUM_THREADS: "24"
      OPENCV_NUM_THREADS: "24"
    shm_size: "16g"
    deploy:
      resources:
        limits:
          memory: 64g
        reservations:
          devices:
            - driver: nvidia
              count: 1
              capabilities: [gpu]

  web:
    build:
      context: .
      dockerfile: Dockerfile
    image: neural-style:gpu-cuda126
    working_dir: /app
    command: >-
      bash -lc "pip install flask && python /app/web/app.py"
    volumes:
      - ./:/app
    ports:
      - "5001:5000"
    env_file:
      - .env
    environment:
      OMP_NUM_THREADS: "24"
      OPENBLAS_NUM_THREADS: "24"
      MKL_NUM_THREADS: "24"
      NUMEXPR_NUM_THREADS: "24"
      OPENCV_NUM_THREADS: "24"
      FLASK_ENV: "development"
    shm_size: "16g"
    deploy:
      resources:
        limits:
          memory: 64g
        reservations:
          devices:
            - driver: nvidia
              count: 1
              capabilities: [gpu]
